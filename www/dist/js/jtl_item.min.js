/*
 * JTL Item v1.3.0 - http://apex.world/plugins/
 *
 * Licensed under MIT License (MIT)
 * Jorge Rimblas Â© 2017-2020
*/
$.widget("ui.jtlItem",{options:{lang:"en",lang_codes:[],messages:null,itemName:"",fieldSize:30,fieldRows:5,fieldMaxLength:80,dialogTitle:null},log:function(){var e=Array.prototype.join.call(arguments,", ");apex.debug.message(4,"jtlitem:",e)},elog:function(e,t){apex.debug.message(4,"jtlitem:",e,t)},_topApex:apex.util.getTopApex(),_createPrivateStorage:function(){this._item$=$("#"+this.options.itemName),this._values={fieldSize:30,fieldMaxLength:80,dataJSON:{},curr_lang_index:0,languages:{},tagMap:{},messages:JSON.parse(this.options.messages),totalLanguages:0,disabled:!1,newRecord:!1,popupClass:"jtlitem-dialog",popupSEL:"div.jtlitem-dialog",controllerMode:this.options.controllerMode},this._elements={$window:{},$document:{},$body:{},$itemset:{},$mlsButton:{},$ig:{},$grid:{},$dialog:{},$dialogContent:{},$saveButton:{},$cancelButton:{},$buttonContainer:{}}},_create:function(){var e=this,t={};e.log("_create"),e.log(e.options.itemName),e._addCSSToTopLevel(),e._createPrivateStorage(),e._initElements(),e._initBaseElements();try{e._values.languages=JSON.parse(e.options.lang_codes)}catch(t){console.error("The defined languages are not formatted correctly. See Shared Componets > Components Settings > JTL Item [Plug-in]",e.options.lang_codes)}e._values.totalLanguages=e._values.languages.length,e._values.controllerMode&&!e.element.data("value")||(t=e.element.data("value")),e._initDataJSON(t),e._values.curr_lang_index=function(e,t){var i=null,a=-1;for(i=0;e.length>i&&-1==a;i+=1)e[i].l===t&&(a=i);return a}(e._values.dataJSON,e.options.lang),e._item$.bind("change",{uiw:e},e._syncJSONdata),e._elements.$document.bind("apexbeforepagesubmit",{uiw:e},e._syncJSONdata),e._elements.$mlsButton.bind("click",{uiw:e},e._handleOpenClick),e._initApexItem(),apex.jQuery(window).on("interactivegridviewmodelcreate",function(t,i){e._initGridConfig()})},_initGridConfig:function(){var e=this,t=apex.region.findClosest(e._item$[0]);e.log("_initGridConfig"),e.elog("uiw._item$",e._item$),e.elog("region",t),e._values.controllerMode?(e._elements.$ig=t.widget().interactiveGrid(),e._elements.$grid=t.widget().interactiveGrid("getViews").grid,e.elog("_elements.$grid:",e._elements.$grid)):e.log("not an IG")},_resetFocus:function(){var e=this;if(e.log("_resetFocus"),e._values.controllerMode)try{var t=e._elements.$grid.model.getRecordId(e._elements.$grid.view$.grid("getSelectedRecords")[0]),i=e._elements.$ig.interactiveGrid("option").config.columns.filter(function(t){return t.staticId===e.options.itemName})[0];e._elements.$grid.view$.grid("gotoCell",t,i.name),e._elements.$grid.focus()}catch(e){console.warn("There were problems trying to refocus on the cell being edited")}else e._item$.trigger("focus")},_initApexItem:function(){var e=this;e.log("_initApexItem","Registering with apex.item.create for "+e.options.itemName),apex.item.create(e.options.itemName,{setValue:function(t,i){e.log("apex.item.setValue",t,i),e._initDataJSON(JSON.parse(t||"{}")),i||!t||0===t.length?e._item$.val():(i||(i=e._getTL(e.options.lang)),e._item$.val(i))},getValue:function(){return JSON.stringify(e._values.dataJSON)},setFocus:function(){e._item$.trigger("focus")},enable:function(){e.enable()},disable:function(){e.disable()},getPopupSelector:function(){return e._values.popupSEL},displayValueFor:function(t){var i,a,n={};if(e.log("apex.item.displayValueFor",t),t)try{n=JSON.parse(t)}catch(e){}return i=e._values.dataJSON,e._initDataJSON(n),a=e._getTL(e.options.lang),e._initDataJSON(i),a}})},_addCSSToTopLevel:function(){if(window!==window.top){var e='link[rel="stylesheet"][href*="jtl_item"]';0===this._topApex.jQuery(e).length&&this._topApex.jQuery("head").append($(e).clone())}},_initElements:function(){this._elements.$window=this._topApex.jQuery(window),this._elements.$document=this._topApex.jQuery(window.top.document),this._elements.$body=this._topApex.jQuery(window.top.document.body)},_initDialogElements:function(){this._elements.$dialogContent=this._topApex.jQuery("div.jtlitem-content"),this._elements.$saveButton=this._topApex.jQuery("button.jtlitem-save-button"),this._elements.$cancelButton=this._topApex.jQuery("button.jtlitem-cancel-button")},_initBaseElements:function(){var e=this;e.log("_initBaseElements"),e.elog("element",e.element),e._values.fieldSize="TEXT"===e.options.itemType?e._item$.attr("size"):e._item$.attr("cols"),"TEXTAREA"===e.options.itemType&&(e._values.fieldRows=e._item$.attr("rows")),e._values.fieldMaxLength=e._item$.attr("maxlength"),e._elements.$itemset=e._item$.parent(),e._elements.$mlsButton=e._elements.$itemset.find("button.jtlitem-modal-open")},_syncLanguageMap:function(){var e,t=null;for(this.log("_syncLanguageMap"),e=this._values.dataJSON,this._values.tagMap={},t=0;e.length>t;t+=1)this._values.tagMap[e[t].l]=e[t].tl},_getTL:function(e){return this._values.tagMap[e]},_initDataJSON:function(e){var t=[],i=e||{};this.log("_initDataJSON"),this.elog({input_data:i}),apex.jQuery.isEmptyObject(i)?(this.log("Initializing with empty value"),this._values.languages.forEach(function(e){t.push({l:e,tl:""})}),this._values.dataJSON=t,this._values.newRecord=!0):(this._values.dataJSON=i,this._values.newRecord=!1),this._syncLanguageMap()},_syncJSONdata:function(e){var t;if((t=void 0!==e?e.data.uiw:this).log("_syncJSONdata"),t._values.newRecord)for(var i=t._values.totalLanguages-1;i>=0;i--)t._values.dataJSON[i].tl=t._item$.val();else t._values.dataJSON[t._values.curr_lang_index].tl=t._item$.val();t._syncLanguageMap()},_initDialogButtons:function(){this._elements.$cancelButton.bind("click",{uiw:this},this._handleCancelButtonClick),this._elements.$saveButton.bind("click",{uiw:this},this._handleSaveButtonClick)},_handleCancelButtonClick:function(e){var t=e.data.uiw;t._values.newRecord=!1,t._elements.$dialog.dialog("close")},_handleSaveButtonClick:function(e){var t,i=e.data.uiw;i._elements.$dialogContent.find(".jtlitem-value").each(function(e,a){i._values.dataJSON[e].l=a.dataset.lang,i._values.dataJSON[e].tl=a.value,i._values.curr_lang_index===e&&(t=a.value)}),i._syncLanguageMap(),i._values.newRecord=!1,i._item$.val(t),i._signalChange(),i._elements.$dialog.dialog("close")},_signalChange:function(){apex.jQuery(this._item$[0]).trigger("change")},_handleOpenClick:function(e){var t=e.data.uiw;t.log("_handleOpenClick"),t._syncJSONdata(e),t._showDialog()},_showDialog:function(){var e,t,i,a=this,n=a._values.curr_lang_index;a.log("_showDialog"),!a._values.controllerMode&&apex.jQuery.isEmptyObject(a._elements.$grid)||(a.log("we didn't get a hold of the grid, maybe try again"),a._initGridConfig()),e='<table class="t-Report-report" summary="Available Translations">\n <tr>\n  <th class="t-Report-colHead">'+a._values.messages.languageLabel+'</th>  <th class="t-Report-colHead u-tL">'+a._values.messages.languageValue+"</th> </tr>\n",$.each(a._values.languages,function(t,i){e+=" <tr"+(n==t?' class="selected"':"")+'>\n  <td class="t-Report-cell t-Form-inputContainer u-tC">'+apex.util.escapeHTMLAttr(i)+'</td>  <td class="t-Report-cell t-Form-inputContainer u-tL">',"TEXT"===a.options.itemType?e+='    <input type="text" class="text_field apex-item-text jtlitem-value" data-lang="'+i+'" value="'+apex.util.escapeHTMLAttr(a._getTL(i))+'" size="'+a._values.fieldSize+'" maxlength="'+a._values.fieldMaxLength+'"></td>':e+='    <textarea class="textarea apex-item-textarea jtlitem-value" data-lang="'+i+'" cols="'+a._values.fieldSize+'" rows="'+a._values.fieldRows+'" maxlength="'+a._values.fieldMaxLength+'">'+apex.util.escapeHTMLAttr(a._getTL(i))+"</textarea>",e+=" </tr>\n"}),e+="</table>\n",i='<div class="'+a._values.popupClass+'"><div class="jtlitem-container ui-widget">\n  <div class="jtlitem-button-container">\n     <button class="jtlitem-cancel-button t-Button">       <span class="t-Button-label">'+a._values.messages.cancelButton+'</span>     </button>\n     <button class="jtlitem-save-button t-Button t-Button--hot">       <span class="t-Button-label">'+a._values.messages.applyChanges+'</span>       <span class="t-Icon t-Icon--right fa fa-check"></span>     </button>\n  </div>\n  <div class="jtlitem-content">\n'+e+"  </div>\n</div></div>\n",a._elements.$body.append(i),a._elements.$dialog=a._topApex.jQuery(a._values.popupSEL),t=window===window.top?{my:"left",at:"left center",of:a._item$[0]}:{my:"center center",at:"center center",of:a._topApex.jQuery(".ui-dialog")[0]},a._elements.$dialog.dialog({closeOnEscape:!0,title:a.options.dialogTitle,autoResize:!0,minWidth:400,minHeight:250,width:"auto",height:"auto",modal:!0,dialogClass:"ui-dialog",position:t,open:function(){a._initDialogElements(),a._initDialogButtons(),a._elements.$dialogContent.find("tr.selected .jtlitem-value").trigger("focus")},close:function(){a._elements.$dialog.remove(),a._elements.$document.find(a._values.popupSEL).remove(),a._resetFocus()}}).on("keydown",function(e){e.keyCode===$.ui.keyCode.ESCAPE&&a._elements.$dialog.dialog("close"),e.stopPropagation()})},disable:function(){!1===this._values.disabled&&(this._item$.attr("disabled","disabled"),this._elements.$mlsButton.attr("disabled","disabled").unbind("click",this._handleOpenClick)),this._values.disabled=!0},enable:function(){!0===this._values.disabled&&(this._item$.removeAttr("disabled"),this._elements.$mlsButton.removeAttr("disabled").bind("click",{uiw:this},this._handleOpenClick),this._values.disabled=!1)}});