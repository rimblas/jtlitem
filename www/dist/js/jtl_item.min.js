/*
 * JTL Item v1.1 - http://apex.world/plugins/
 *
 * Licensed under MIT License (MIT)
 * Jorge Rimblas Â© 2017-2020
*/
$.widget("ui.jtlItem",{options:{lang:"en",lang_codes:[],messages:null,itemName:"",fieldSize:30,fieldRows:5,fieldMaxLength:80,dialogTitle:null},log:function(){var e=Array.prototype.join.call(arguments,", ");apex.debug.message(4,"jtlitem:",e)},elog:function(e,t){apex.debug.message(4,"jtlitem:",e,t)},_topApex:apex.util.getTopApex(),_initGridConfig:function(){var e=this,t=apex.region.findClosest(e._item$[0]);e.log("_initGridConfig"),e.elog("uiw._item$",e._item$),e.elog("region",t),e._values.igMode?(e._elements.$ig=t.widget().interactiveGrid(),e._elements.$grid=t.widget().interactiveGrid("getViews").grid,e.elog("_elements.$grid:",e._elements.$grid),t.widget().on("interactivegridsave",function(){e._elements.$grid.setEditMode(!1)})):e.log("not an IG")},_resetFocus:function(){var e=this;if(e.log("_resetFocus"),e._values.igMode){e.elog("uiw._elements.$grid",e._elements.$grid),e.elog("uiw._elements.$ig",e._elements.$ig);var t=e._elements.$grid.model.getRecordId(e._elements.$grid.view$.grid("getSelectedRecords")[0]),i=e._elements.$ig.interactiveGrid("option").config.columns.filter(function(t){return t.staticId===e.options.itemName})[0];e._elements.$grid.view$.grid("gotoCell",t,i.name),e._elements.$grid.focus()}else e._item$.trigger("focus")},_createPrivateStorage:function(){this._item$=$("#"+this.options.itemName),this._values={fieldSize:30,fieldMaxLength:80,dataJSON:{},curr_lang_index:0,languages:{},tagMap:{},messages:JSON.parse(this.options.messages),grid:null,totalLanguages:0,disabled:!1,newRecord:!1,igMode:this.options.igMode},this._elements={$window:{},$document:{},$body:{},$itemset:{},$mlsButton:{},$ig:{},$dialog:{},$dialogContent:{},$saveButton:{},$cancelButton:{},$buttonContainer:{}}},_create:function(){var e=this,t={};e.log("_create"),e.log(e.options.itemName),e._createPrivateStorage(),e._initElements(),e._initBaseElements();try{e._values.languages=JSON.parse(e.options.lang_codes)}catch(t){console.error("The defined languages are not formatted correctly. See Shared Componets > Components Settings > JTL Item [Plug-in]",e.options.lang_codes)}e._values.totalLanguages=e._values.languages.length,e._values.igMode&&!e.element.data("value")||(t=e.element.data("value")),e._initDataJSON(t),e._values.curr_lang_index=function(e,t){var i=null,a=-1;for(i=0;e.length>i&&-1==a;i+=1)e[i].l===t&&(a=i);return a}(e._values.dataJSON,e.options.lang),e._item$.bind("change",{uiw:e},e._syncJSONdata),e._elements.$document.bind("apexbeforepagesubmit",{uiw:e},e._syncJSONdata),e._elements.$mlsButton.bind("click",{uiw:e},e._handleOpenClick),e._initApexItem(),apex.jQuery(window).on("interactivegridviewmodelcreate",function(t,i){e._initGridConfig()})},_initApexItem:function(){var e=this;e.log("_initApexItem","Registering with apex.item.create for "+e.options.itemName),apex.item.create(e.options.itemName,{setValue:function(t,i){e.log("apex.item.setValue",t,i),e._initDataJSON(JSON.parse(t||"{}")),i||!t||0===t.length||(i||(i=e._getTL(e.options.lang)),e._item$.val(i))},getValue:function(){return JSON.stringify(e._values.dataJSON)},setFocus:function(){e._item$.trigger("focus")},enable:function(){e.enable()},disable:function(){e.disable()},displayValueFor:function(t){var i={};if(e.log("apex.item.displayValueFor",t),t)try{i=JSON.parse(t)}catch(e){}return e._initDataJSON(i),e._getTL(e.options.lang)}})},_initElements:function(){this._elements.$window=$(window),this._elements.$document=$(document),this._elements.$body=$(document.body)},_initDialogElements:function(){this._elements.$dialogContent=$("div.jtlitem-content"),this._elements.$saveButton=$("button.jtlitem-save-button"),this._elements.$cancelButton=$("button.jtlitem-cancel-button")},_initBaseElements:function(){var e=this;e.log("_initBaseElements"),e.elog("element",e.element),e._values.fieldSize="TEXT"===e.options.itemType?e._item$.attr("size"):e._item$.attr("cols"),"TEXTAREA"===e.options.itemType&&(e._values.fieldRows=e._item$.attr("rows")),e._values.fieldMaxLength=e._item$.attr("maxlength"),e._elements.$itemset=e._item$.parent(),e._elements.$mlsButton=e._elements.$itemset.find("button.jtlitem-modal-open")},_syncLanguageMap:function(){var e,t=null;for(this.log("_syncLanguageMap"),e=this._values.dataJSON,this._values.tagMap={},t=0;e.length>t;t+=1)this._values.tagMap[e[t].l]=e[t].tl},_getTL:function(e){return this._values.tagMap[e]},_initDataJSON:function(e){var t=[],i=e||{};this.log("_initDataJSON"),this.elog({input_data:i}),apex.jQuery.isEmptyObject(i)?(this.log("Initializing with empty value"),this._values.languages.forEach(function(e){t.push({l:e,tl:""})}),this._values.dataJSON=t,this._values.newRecord=!0):(this._values.dataJSON=i,this._values.newRecord=!1),this._syncLanguageMap()},_syncJSONdata:function(e){var t,i;if((t=void 0!==e?e.data.uiw:this).log("_syncJSONdata"),i=t._values.curr_lang_index,t._values.newRecord)for(var a=t._values.totalLanguages-1;a>=0;a--)t._values.dataJSON[a].tl=t._item$.val();else t._values.dataJSON[i].tl=t._item$.val();t._syncLanguageMap()},_initDialogButtons:function(){this._elements.$cancelButton.bind("click",{uiw:this},this._handleCancelButtonClick),this._elements.$saveButton.bind("click",{uiw:this},this._handleSaveButtonClick)},_handleCancelButtonClick:function(e){var t=e.data.uiw;t._values.newRecord=!1,t._elements.$dialog.dialog("close")},_handleSaveButtonClick:function(e){var t,i=e.data.uiw;i._elements.$dialogContent.find(".jtlitem-value").each(function(e,a){i.log(e+"("+a.dataset.lang+"):"+a.value),i._values.dataJSON[e].l=a.dataset.lang,i._values.dataJSON[e].tl=a.value,i._values.curr_lang_index==e&&(t=a.value)}),i._syncLanguageMap(),i._values.newRecord=!1,i._item$.val(t),i._signalChange(),i._elements.$dialog.dialog("close")},_signalChange:function(){apex.jQuery(this._item$[0]).trigger("change")},_handleOpenClick:function(e){var t=e.data.uiw;t.log("_handleOpenClick"),t._syncJSONdata(e),t._showDialog()},_showDialog:function(){var e,t,i=this,a=i._values.curr_lang_index;i.log("_showDialog"),e='<table class="t-Report-report" summary="Available Translations">\n <tr>\n  <th class="t-Report-colHead">'+i._values.messages.languageLabel+'</th>  <th class="t-Report-colHead u-tL">'+i._values.messages.languageValue+"</th> </tr>\n",$.each(i._values.languages,function(t,n){e+=" <tr"+(a==t?' class="selected"':"")+'>\n  <td class="t-Report-cell t-Form-inputContainer u-tC">'+apex.util.escapeHTMLAttr(n)+'</td>  <td class="t-Report-cell t-Form-inputContainer u-tL">',"TEXT"===i.options.itemType?e+='    <input type="text" class="text_field apex-item-text jtlitem-value" data-lang="'+n+'" value="'+apex.util.escapeHTMLAttr(i._getTL(n))+'" size="'+i._values.fieldSize+'" maxlength="'+i._values.fieldMaxLength+'"></td>':e+='    <textarea class="textarea apex-item-textarea jtlitem-value" data-lang="'+n+'" cols="'+i._values.fieldSize+'" rows="'+i._values.fieldRows+'" maxlength="'+i._values.fieldMaxLength+'">'+apex.util.escapeHTMLAttr(i._getTL(n))+"</textarea>",e+=" </tr>\n"}),e+="</table>\n",t='<div class="jtlitem-dialog"><div class="jtlitem-container ui-widget">\n  <div class="jtlitem-button-container">\n     <button class="jtlitem-cancel-button t-Button">       <span class="t-Button-label">'+i._values.messages.cancelButton+'</span>     </button>\n     <button class="jtlitem-save-button t-Button t-Button--hot">       <span class="t-Button-label">'+i._values.messages.applyChanges+'</span>       <span class="t-Icon t-Icon--right fa fa-check"></span>     </button>\n  </div>\n  <div class="jtlitem-content">\n'+e+"  </div>\n</div></div>\n",i._elements.$body.append(t),i._elements.$dialog=$("div.jtlitem-dialog"),i._elements.$dialog.dialog({closeOnEscape:!0,title:i.options.dialogTitle,autoResize:!0,minWidth:400,minHeight:250,width:"auto",height:"auto",modal:!0,position:{my:"left",at:"left center",of:i._item$[0]},open:function(){i._initDialogElements(),i._initDialogButtons(),i._elements.$dialogContent.find("tr.selected .jtlitem-value").trigger("focus")},close:function(){$(this).dialog("destroy"),i._elements.$dialog.remove(),i._elements.$document.find("div.jtlitem-dialog").remove(),i._resetFocus()}}).on("keydown",function(e){e.keyCode===$.ui.keyCode.ESCAPE&&i._elements.$dialog.dialog("close"),e.stopPropagation()})},disable:function(){!1===this._values.disabled&&(this._item$.attr("disabled","disabled"),this._elements.$mlsButton.attr("disabled","disabled").unbind("click",this._handleOpenClick)),this._values.disabled=!0},enable:function(){!0===this._values.disabled&&(this._item$.removeAttr("disabled"),this._elements.$mlsButton.removeAttr("disabled").bind("click",{uiw:this},this._handleOpenClick),this._values.disabled=!1)}});